{"id":"opencode-swarm-monorepo-lf2p4u-mjczzaf28qs","title":"Extract database/data access into separate @swarm/db package","description":"## Goal\nSplit monolithic swarm-mail into focused packages under @swarmtools/* npm org:\n- `@swarmtools/db` - PGlite wrapper, socket adapter, daemon, DatabaseAdapter interface\n- `@swarmtools/streams` - Event store, Effect-TS durable primitives (Mailbox, Cursor, Lock, Deferred)\n- `@swarmtools/hive` - Work item tracking (cells, epics, dependencies, git sync)\n- `@swarmtools/memory` - Semantic memory, embeddings, decay, Ollama integration\n- `@swarmtools/mail` - Agent coordination (messages, reservations, inbox)\n- `swarm-mail` - Re-exports all above (backward compatibility)\n\n## Dependency Order (bottom-up)\n```\n@swarmtools/db (foundation - no deps)\n    ↓\n@swarmtools/streams ─┬─ @swarmtools/hive ─┬─ @swarmtools/memory\n                     │                    │\n                     └────────────────────┴─→ @swarmtools/mail\n                                                    ↓\n                                              swarm-mail (re-exports)\n```\n\n## Benefits\n- Clear boundaries between concerns\n- Independent versioning per package\n- Smaller install footprint (use only what you need)\n- Easier testing (isolated packages)\n- Better tree-shaking\n\n## Past Learnings Applied\n1. Turborepo needs packageManager field in root package.json\n2. bun build doesn't resolve workspace:* - must build deps first with turbo\n3. TypeScript declarations need emitDeclarationOnly:true plus tsc\n4. Re-export everything for backward compatibility\n5. Coordinator should NOT reserve files - only workers reserve","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-19T15:01:41.630Z","updated_at":"2025-12-19T15:38:25.489Z","closed_at":"2025-12-19T15:38:25.489Z","dependencies":[],"labels":[],"comments":[]}
{"id":"opencode-swarm-monorepo-lf2p4u-mjd0tmi96be","title":"Daemon-owned Durable Streams with RPC exposure","description":"## Opportunity\n\nNow that daemon owns the PGlite instance, it could also own the Durable Streams primitives (Mailbox, Cursor, Lock, Deferred) and expose them via RPC.\n\n## Current Architecture\n```\nClient Process                    Daemon\n     │                              │\n     │ ──── SQL query ────────────► │ PGlite\n     │ ◄─── rows ─────────────────  │\n     │                              │\n     │ ──── SQL query ────────────► │\n     │ ◄─── rows ─────────────────  │\n     │                              │\n     │  (N round-trips per op)      │\n```\n\n## Proposed Architecture\n```\nClient Process                    Daemon\n     │                              │\n     │ ── mailbox.send(msg) ──────► │ Mailbox\n     │ ◄── ack ───────────────────  │   │\n     │                              │   ▼\n     │ ── cursor.advance() ───────► │ PGlite\n     │ ◄── position ──────────────  │\n     │                              │\n     │  (1 round-trip per op)       │\n```\n\n## Benefits\n- **Fewer round-trips** - Complex operations (send + wait for ack) become single RPC\n- **Server-side batching** - Daemon can batch multiple operations\n- **Simpler client** - No need to manage transactions client-side\n- **Better atomicity** - Operations that span multiple tables stay atomic\n\n## Implementation Ideas\n1. Define RPC protocol (JSON-RPC? gRPC? custom?)\n2. Expose Durable Streams methods: `mailbox.send()`, `cursor.advance()`, `lock.acquire()`, etc.\n3. Keep raw SQL access for flexibility\n4. Consider Effect-TS RPC layer\n\n## Depends On\n- Daemon mode default (done ✅)\n- Package extraction (@swarm/db, @swarm/streams) - nice to have first\n\n## Complexity\nMedium-High - requires RPC protocol design and client/server split of Durable Streams.","status":"open","priority":3,"issue_type":"feature","created_at":"2025-12-19T15:25:16.977Z","updated_at":"2025-12-19T15:25:16.977Z","dependencies":[],"labels":[],"comments":[]}
{"id":"opencode-swarm-monorepo-lf2p4u-mjd1aeddf27","title":"Extract swarm-mail into @swarmtools/* packages","description":"Split monolithic swarm-mail into focused packages: @swarmtools/db, @swarmtools/streams, @swarmtools/hive, @swarmtools/memory, @swarmtools/mail. swarm-mail becomes backward-compat re-export layer. Dependency order: db → streams/hive/memory → mail → swarm-mail.","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-19T15:38:19.585Z","updated_at":"2025-12-19T15:38:19.585Z","dependencies":[],"labels":[],"comments":[]}
{"id":"opencode-swarm-monorepo-lf2p4u-mjd1aedoqkg","title":"Create @swarmtools/db package (foundation)","description":"## Goal\nCreate packages/db/ with DatabaseAdapter interface, PGlite wrapper, socket adapter, daemon, WAL health monitoring.\n\n## Files to Extract from swarm-mail\n- `src/types/database.ts` → DatabaseAdapter interface, QueryResult, DatabaseConfig\n- `src/pglite.ts` → PGlite convenience layer (getSwarmMail, createInMemorySwarmMail, etc.)\n- `src/pglite.*.ts` → All PGlite tests\n- `src/socket-adapter.ts` → postgres.js wrapper for daemon mode\n- `src/daemon.ts` → PGlite daemon lifecycle\n- `src/daemon.test.ts`\n- `src/adapter.wal-health.test.ts`\n\n## Package Structure\n```\npackages/db/\n├── src/\n│   ├── index.ts           # Re-exports\n│   ├── types.ts           # DatabaseAdapter, QueryResult, DatabaseConfig\n│   ├── pglite.ts          # PGlite convenience layer\n│   ├── socket-adapter.ts  # postgres.js wrapper\n│   └── daemon.ts          # Daemon lifecycle\n├── package.json           # @swarmtools/db\n└── tsconfig.json\n```\n\n## Dependencies\n- `@electric-sql/pglite`\n- `@electric-sql/pglite-socket`\n- `postgres`\n- `proper-lockfile`\n\n## Key Constraint\nThis is the FOUNDATION package - no internal @swarmtools/* dependencies.\n\n## Skill\nUse `publish-package-cicd` for package.json setup.","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-19T15:38:19.596Z","updated_at":"2025-12-19T15:38:31.935Z","parent_id":"opencode-swarm-monorepo-lf2p4u-mjd1aeddf27","dependencies":[],"labels":[],"comments":[]}
{"id":"opencode-swarm-monorepo-lf2p4u-mjd1aedvas6","title":"Create @swarmtools/streams package (event sourcing)","description":"## Goal\nCreate packages/streams/ with event store, Effect-TS durable primitives.\n\n## Files to Extract from swarm-mail\n- `src/streams/store.ts` → Event store (append, read, subscribe)\n- `src/streams/events.ts` → Event types and schemas\n- `src/streams/migrations.ts` → Schema migrations\n- `src/streams/projections.ts` → Materialized views\n- `src/streams/effect/` → Effect-TS primitives:\n  - `mailbox.ts` - Actor mailbox\n  - `cursor.ts` - Stream cursor\n  - `lock.ts` - Distributed lock\n  - `deferred.ts` - Promise-like primitive\n  - `ask.ts` - Request/response pattern\n  - `layers.ts` - Effect layers\n- `src/streams/leader-election.ts` → Multi-process coordination\n- `src/streams/debug.ts` → Debug utilities\n\n## Package Structure\n```\npackages/streams/\n├── src/\n│   ├── index.ts\n│   ├── store.ts\n│   ├── events.ts\n│   ├── migrations.ts\n│   ├── projections.ts\n│   ├── leader-election.ts\n│   └── effect/\n│       ├── index.ts\n│       ├── mailbox.ts\n│       ├── cursor.ts\n│       ├── lock.ts\n│       ├── deferred.ts\n│       └── ask.ts\n├── package.json           # @swarmtools/streams\n└── tsconfig.json\n```\n\n## Dependencies\n- `@swarmtools/db` (workspace:*)\n- `effect`\n- `zod`\n- `nanoid`\n\n## Depends On\nSubtask 0: @swarmtools/db must exist first.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-19T15:38:19.603Z","updated_at":"2025-12-19T15:38:38.297Z","parent_id":"opencode-swarm-monorepo-lf2p4u-mjd1aeddf27","dependencies":[],"labels":[],"comments":[]}
{"id":"opencode-swarm-monorepo-lf2p4u-mjd1aee0rg1","title":"Create @swarmtools/hive package (work items)","description":"## Goal\nCreate packages/hive/ with work item tracking (cells, epics, dependencies, git sync).\n\n## Files to Extract from swarm-mail\n- Entire `src/hive/` directory:\n  - `adapter.ts` → HiveAdapter interface\n  - `store.ts` → Cell CRUD operations\n  - `operations.ts` → Business logic\n  - `queries.ts` → Query builders\n  - `projections.ts` → Materialized views\n  - `dependencies.ts` → Dependency graph\n  - `jsonl.ts` → JSONL persistence\n  - `merge.ts` → Git merge conflict resolution\n  - `migrations.ts` → Schema migrations\n  - `validation.ts` → Zod schemas\n  - `events.ts` → Event types\n  - `labels.ts`, `comments.ts` → Metadata\n  - `blocked-cache.ts` → Blocked status cache\n  - `flush-manager.ts` → Write batching\n\n## Package Structure\n```\npackages/hive/\n├── src/\n│   ├── index.ts\n│   ├── adapter.ts\n│   ├── store.ts\n│   ├── operations.ts\n│   ├── queries.ts\n│   ├── projections.ts\n│   ├── dependencies.ts\n│   ├── jsonl.ts\n│   ├── merge.ts\n│   ├── migrations.ts\n│   └── validation.ts\n├── package.json           # @swarmtools/hive\n└── tsconfig.json\n```\n\n## Dependencies\n- `@swarmtools/db` (workspace:*)\n- `zod`\n- `nanoid`\n\n## Key Constraint\nDoes NOT depend on @swarmtools/streams - hive is independent of event sourcing.\n\n## Depends On\nSubtask 0: @swarmtools/db must exist first.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-19T15:38:19.608Z","updated_at":"2025-12-19T15:38:42.639Z","parent_id":"opencode-swarm-monorepo-lf2p4u-mjd1aeddf27","dependencies":[],"labels":[],"comments":[]}
{"id":"opencode-swarm-monorepo-lf2p4u-mjd1aee4l0m","title":"Create @swarmtools/memory package (semantic memory)","description":"## Goal\nCreate packages/memory/ with semantic memory store, Ollama embeddings, decay.\n\n## Files to Extract from swarm-mail\n- Entire `src/memory/` directory:\n  - `store.ts` → Memory CRUD, search, decay\n  - `adapter.ts` → MemoryAdapter interface\n  - `ollama.ts` → Ollama embedding client\n  - `migrations.ts` → Schema migrations\n  - `sync.ts` → JSONL export/import for git\n  - `migrate-legacy.ts` → Legacy DB migration\n\n## Package Structure\n```\npackages/memory/\n├── src/\n│   ├── index.ts\n│   ├── store.ts\n│   ├── adapter.ts\n│   ├── ollama.ts\n│   ├── migrations.ts\n│   ├── sync.ts\n│   └── migrate-legacy.ts\n├── package.json           # @swarmtools/memory\n└── tsconfig.json\n```\n\n## Dependencies\n- `@swarmtools/db` (workspace:*)\n- `zod`\n- `nanoid`\n\n## Key Constraint\nDoes NOT depend on @swarmtools/streams - memory is independent of event sourcing.\n\n## Depends On\nSubtask 0: @swarmtools/db must exist first.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-19T15:38:19.612Z","updated_at":"2025-12-19T15:38:46.246Z","parent_id":"opencode-swarm-monorepo-lf2p4u-mjd1aeddf27","dependencies":[],"labels":[],"comments":[]}
{"id":"opencode-swarm-monorepo-lf2p4u-mjd1aee792p","title":"Create @swarmtools/mail package (agent coordination)","description":"## Goal\nCreate packages/mail/ with agent coordination (messages, reservations, inbox).\n\n## Files to Extract from swarm-mail\n- `src/streams/agent-mail.ts` → Agent registration, messaging\n- `src/streams/swarm-mail.ts` → SwarmMail facade\n- `src/types/adapter.ts` → SwarmMailAdapter interface\n- `src/adapter.ts` → createSwarmMailAdapter factory\n\n## Package Structure\n```\npackages/mail/\n├── src/\n│   ├── index.ts\n│   ├── adapter.ts         # createSwarmMailAdapter\n│   ├── types.ts           # SwarmMailAdapter, Message, Reservation\n│   ├── agent-mail.ts      # Agent registration, messaging\n│   └── swarm-mail.ts      # Facade\n├── package.json           # @swarmtools/mail\n└── tsconfig.json\n```\n\n## Dependencies\n- `@swarmtools/db` (workspace:*)\n- `@swarmtools/streams` (workspace:*)\n- `zod`\n- `nanoid`\n- `minimatch`\n\n## Key Constraint\nThis package depends on BOTH db and streams - it's the coordination layer.\n\n## Depends On\n- Subtask 0: @swarmtools/db\n- Subtask 1: @swarmtools/streams","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-19T15:38:19.615Z","updated_at":"2025-12-19T15:38:50.039Z","parent_id":"opencode-swarm-monorepo-lf2p4u-mjd1aeddf27","dependencies":[],"labels":[],"comments":[]}
{"id":"opencode-swarm-monorepo-lf2p4u-mjd1aeeau9x","title":"Update swarm-mail as re-export meta-package","description":"## Goal\nTransform swarm-mail into a thin re-export layer for backward compatibility.\n\n## Changes\n1. Update `package.json`:\n   - Add dependencies on all @swarmtools/* packages\n   - Keep existing version/exports for compatibility\n\n2. Update `src/index.ts`:\n   - Re-export from @swarmtools/db\n   - Re-export from @swarmtools/streams\n   - Re-export from @swarmtools/hive\n   - Re-export from @swarmtools/memory\n   - Re-export from @swarmtools/mail\n\n3. Add deprecation notices:\n   ```typescript\n   /** @deprecated Import from @swarmtools/db instead */\n   export { DatabaseAdapter } from \"@swarmtools/db\";\n   ```\n\n## Verification\n- All existing imports from `swarm-mail` must continue to work\n- Run full test suite to verify backward compatibility\n- No breaking changes to public API\n\n## Depends On\nAll 5 package creation subtasks (0-4) must complete first.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-19T15:38:19.618Z","updated_at":"2025-12-19T15:38:54.019Z","parent_id":"opencode-swarm-monorepo-lf2p4u-mjd1aeddf27","dependencies":[],"labels":[],"comments":[]}
{"id":"opencode-swarm-monorepo-lf2p4u-mjd1aeebjur","title":"Update opencode-swarm-plugin imports","description":"## Goal\nUpdate opencode-swarm-plugin to use new package structure.\n\n## Options\n1. **Continue using swarm-mail re-exports** (minimal change)\n   - Imports stay as `from \"swarm-mail\"`\n   - Benefit: No code changes needed\n   - Drawback: Doesn't demonstrate new packages\n\n2. **Update to @swarmtools/* imports** (recommended)\n   - Change `from \"swarm-mail\"` to specific packages\n   - Benefit: Cleaner dependencies, better tree-shaking\n   - Drawback: More changes\n\n## Verification\n- `bun turbo typecheck` passes\n- `bun turbo test` passes\n- All plugin tools work correctly\n\n## Depends On\nSubtask 5: swarm-mail re-export layer must be complete.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-19T15:38:19.619Z","updated_at":"2025-12-19T15:38:58.181Z","parent_id":"opencode-swarm-monorepo-lf2p4u-mjd1aeddf27","dependencies":[],"labels":[],"comments":[]}
{"id":"opencode-swarm-monorepo-lf2p4u-mjd1aeedanh","title":"Setup @swarmtools npm org and CI publishing","description":"## Goal\nSetup @swarmtools npm org and configure CI publishing for all new packages.\n\n## Tasks\n1. **Create npm org** (manual - Joel does this)\n   - Go to npmjs.com → Create Organization → @swarmtools\n   - Add team members\n\n2. **Update root package.json**\n   ```json\n   {\n     \"workspaces\": [\n       \"packages/*\",\n       \"apps/*\"\n     ]\n   }\n   ```\n\n3. **Update turbo.json**\n   - Add build order respecting dependencies:\n   ```json\n   {\n     \"tasks\": {\n       \"build\": {\n         \"dependsOn\": [\"^build\"]\n       }\n     }\n   }\n   ```\n\n4. **Update .changeset/config.json**\n   - Add new packages to changelog generation\n   - Ensure workspace:* resolution works\n\n5. **Verify build order**\n   ```bash\n   bun turbo build --dry-run\n   # Should show: db → streams/hive/memory → mail → swarm-mail\n   ```\n\n## Skill\nUse `publish-package-cicd` for CI configuration.\n\n## Depends On\nAll 5 package creation subtasks (0-4) must exist first.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-19T15:38:19.621Z","updated_at":"2025-12-19T15:39:02.357Z","parent_id":"opencode-swarm-monorepo-lf2p4u-mjd1aeddf27","dependencies":[],"labels":[],"comments":[]}